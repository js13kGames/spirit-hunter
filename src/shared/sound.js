/* @flow */

import { NoSound } from './constants'

import { nullthrows } from '../util'
import { jsfxr } from '../libs/jsfxr/sfxr'
import { zzfxM } from '../libs/zzfxm/zzfxm.min'
import { zzfxP } from '../libs/zzfxm/zzfx'

type SoundName =
  | 'death'
  | 'hit'
  | 'laser'
  | 'powerup'

interface SoundAudio {
  play(): void
}

const music = { buffer: null, current: null }
const soundbank: {[SoundName]: SoundAudio} = {}

function renderSong (song: Array<mixed>): Promise<empty> {
  return new Promise(resolve => {
    setTimeout(() => resolve(zzfxM(...song)), 20)
  })
}

export async function initSounds () {
  const sounds = [
    'death', '7BMHBGJp1pLzcwfGX3oUr5AAx4BaegfyaxSbpHMiF9ccaB41RnGD94gGi2ZGMe7XnMPXNVnd8t5MMJNeSfBVUfyZbqzLtQUyoDUx1cEJKni316fXo1wWw1LUw',
    'hit', '11111JWCBmwPrHgUYTY22NTVVr8ELS4dgMRCWNP4ns8uo45dKynKrqe7XiR39QS5DwF1ZSCPsFYYHsbLxajA7FBbsV5jBCaoUFRpTiHyCRTDSiKu5riJiJrj',
    'laser', '11111391dYeYMXRc68xUWiTmo4EknU8mxy28cRaz1XUJJN9LuCb38Z2VWXsiz2M2thZ84fV6jSV6rFeyffQ5cBNvDZUg74Ts4Lhz4Pd4aMLyzLehW7AugyUB',
    'powerup', '11111Ho5khiTQRjKTZGV85Lnkbu4eiX47XdQgTHxoBFpKR9maAsSaxoU3ecGMpQhzastitBEGd7KgWxpRjCWMDD2vW6Pk7QnK5abzbvCT8e9ZvtEVrZVyHuy'
  ]

  for (let k = 0; k < sounds.length; k += 2) {
    setTimeout(() => { soundbank[sounds[k]] = jsfxr.sfxr.toAudio(sounds[k + 1]) })
  }

  // eslint-disable-next-line no-sparse-arrays
  music.buffer = await renderSong([[[1.8, 0, 72,,, 0.2,, 4, -2, 6, 50, 0.15,, 6], [, 0, 655,,, 0.09, 3, 1.65,,,,, 0.02, 3.8, -0.1,, 0.2], [1.2, 0, 23,,, 0.2, 3, 4,,, 3, 0.9, 0.05], [1.5, 0, 740,,, 0.15, 2, 0.2, -0.1, -0.15, 9, 0.02,, 0.1, 0.12,, 0.06]], [[[3, -1, 13, 13, 13, 8, 13,,,,,,,,,,,, 11, 11, 11, 6, 11,,,,,,,,,,,, 10, 10, 10, 6, 10,,,,,,,,, 6, 8, 10, 8, 8, 8, 5, 13,, 8, 8, 8, 5, 13,,,,,,], [, 1, 25,, 25,,,,,,,,,,,,, 25, 25,, 25,,,,,,, 25,,, 25,, 25, 25, 25,, 25,,,,,,,,,,, 25, 25, 25, 25,, 25,,,,,,,,,,,,,,], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13,,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,]], [[3, -1, 13, 13, 13, 8, 13,,,,,,,,,,,, 11, 11, 11, 6, 11,,,,,,,,,,,, 10, 10, 10, 6, 10,,,,,,,,, 6, 8, 10, 8, 8, 8, 5, 13,, 8, 8, 8, 5, 13, 8, 8, 8, 5, 13], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25, 27, 11,, 23,, 11, 11, 23, 11,, 11, 23, 11, 11, 11, 23, 22, 18,, 30,, 18, 18, 30, 18,, 18, 30, 18, 18, 18, 30, 22, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,], [, 1, 25,, 25,,,,,,,,,,,,, 25, 25,, 25,,,,,,,,,,,,,, 25,, 25,,,,,,,,,,, 25, 25, 25, 25,, 25,,,,,,,,,,,,,,], [1, 1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,, 13, 13, 13, 13, 13, 13, 13, 13]], [[3, -1, 13, 13, 13, 8, 13,, 13, 15, 17, 17, 15, 13, 20, 20, 18, 17, 18,,,, 17,, 15,,,, 17,, 18,, 22, 22, 22,, 18,,,, 25, 25, 25,, 22,,, 18, 20, 22, 20,,,,,,,,,,,,,,,,], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25, 27, 11,, 23,, 11, 11, 23, 11,, 11, 23, 11, 11, 11, 23, 22, 18,, 30,, 18, 18, 30, 18,, 18, 30, 18, 18, 18, 30, 22, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 11,, 23,, 11, 11, 23, 11,, 11, 23, 11, 11, 11, 23,, 10,, 22,, 10, 10, 22, 10,, 10, 22, 10, 10, 6, 8, 10, 20, 25, 20, 20, 25, 20,, 20, 25, 20, 20, 20, 25,, 20,,], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,,,,,, 8,, 17, 15, 13,, 17, 15, 13,, 15,,,, 10, 13, 15, 10, 13, 15, 10, 13, 15, 10, 13, 15, 12,,,,,, 8, 15,,,,, 17, 15, 13, 8, 13,,,,,, 10, 8,, 20, 20, 20, 20, 20, 20, 20], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 15,, 27,, 15, 15, 27, 15,, 15, 27, 15, 15, 15, 27, 32, 20,, 32,, 20, 20, 32, 20,, 20, 32, 20, 20, 20, 32,, 13,, 25,, 13, 13, 25, 20,, 20, 32, 20, 20, 20, 32,,], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,,,,,, 8,, 17,,,, 18, 17, 15,, 18,,,, 13,,,, 10,,,, 6,,,, 8, 12, 15, 12, 20,, 8, 12, 15, 12, 20,, 22, 20, 15,, 13,,,,,, 10,, 8,,,,, 8, 20, 8], [2, -1, 13,, 25, 25, 13,, 25, 25, 13,, 25, 25, 13,, 25, 25, 15,, 27, 27, 15,, 27, 27, 15,, 27, 27, 15,, 27, 27, 20,, 32, 32, 20,, 32, 32, 20,, 32, 32, 20,, 32, 32, 13,, 25, 25, 13,, 25, 25, 20,, 32, 32, 20,, 32, 34], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,,,,,, 8,, 17,,,, 18, 17, 15,, 18,,,, 13,,,, 10,,,, 6,,,, 8, 12, 15, 12, 20,, 8, 12, 15, 12, 20,, 22, 20, 15,, 13,,,,,, 10,, 8,,,,, 8, 20, 8], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,, 25,,, 25,,,, 25, 25, 25, 25, 25], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13,, 13, 13, 13, 13, 13, 13, 13]]], [0, 1, 2, 2, 3, 3, 2, 2, 4, 4, 5, 6, 6, 7, 2, 2, 3]])
}

export function playSound (name: SoundName) {
  const sound = nullthrows(soundbank[name])
  NoSound || sound.play()
}

export function toggleMusic () {
  if (music.current != null) {
    music.current.stop()
    music.current = null
  } else {
    music.current = zzfxP(...music.buffer)
  }
}
