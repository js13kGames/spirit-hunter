document.write('<!doctype html><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" name=viewport><title>Spirit Hunter</title><link href=./game.css rel=stylesheet><body><script src=./jsfxr/riffwave.js></script><script src=./jsfxr/sfxr.js></script><script src=./zzfxm/zzfx.js></script><script src=./zzfxm/zzfxm.min.js></script>');function wt(i,t,e=0){return!(i.x>t.x+t.width-e||i.x+i.width<t.x+e||i.y>t.y+t.height-e||i.y+i.height<t.y+e)}function P(){}function Lt(i,t){for(let e=i.length;e--;)t(i[e],e,i)}function xt(i){if(i==null)throw new Error("");return i}function A(i,t){return t==null&&(t=i,i=0),Math.floor(Math.random()*(t-i))+i}function Ft(i,t,e){return Math.min(e,Math.max(t,i))}const Vt=60,Bt=1/Vt,Rt=1,b=3,h={context:null,checked:{},holding:{},pressed:{},touched:!1,touches:{}};function Ut(){const i=h.context;i.clearRect(0,0,i.canvas.width,i.canvas.height)}function it(i,t,e,s){const n=h.context;n.beginPath(),n.arc(t,e,s,0,2*Math.PI),i==="fill"?n.fill():n.stroke()}function bt(i,t,e){h.context.drawImage(i,Math.floor(t),Math.floor(e))}function zt(i){return h.context.measureText(i).width}function Ot(i,t,e,s){const n=h.context;n.beginPath(),n.moveTo(i,t),n.lineTo(e,s),n.stroke()}function p(i,t,e,s,n){const r=h.context;s=s??a.width-t;const o=zt(i),d=n==="right"?s-o:n==="center"?.5*(s-o):0;r.fillText(i,Math.floor(t+d),Math.floor(e),s)}function V(i,t,e,s,n,r){const o=h.context;o.beginPath(),o.roundRect(Math.floor(t),Math.floor(e),Math.floor(s),Math.floor(n),r??0),o.fill()}function u(i,t){const e=h.context;e.fillStyle=i,e.strokeStyle=i,e.globalAlpha=t??1}function x(i){const t=h.context;t.font=typeof i=="number"?t.font.replace(/\d+/,String(i)):i}function st(i,t){h.context.translate(Math.floor(i),Math.floor(t))}function Mt(i,t,e=1){const s=document.createElement("canvas"),n=s.getContext("2d");return kt(s,n,i,t,e),[s,n]}function kt(i,t,e,s,n=1){i.width===e&&i.height===s||(i.width=e,i.height=s,t.imageSmoothingEnabled=!1,t.font="8px Consolas, monaco, monospace",t.textBaseline="top",t.scale(n,n))}const a={isMobile:!1,width:0,height:0},W={wasHolding(i){return h.holding[i]===!0},wasPressed(i){return h.pressed[i]===!0?(h.checked[i]=!0,!0):!1}},v={getPosition(i){return h.touches[i]??null},getTouches(){return Object.keys(h.touches)},wasTouched(){return h.touched}};async function Gt(i,t,e){tt(),i!=null&&await i();const s=e??P,n=t??P,[r,o]=Mt(window.innerWidth,window.innerHeight,b);document.body?.appendChild(r),h.context=o,function y(l=_()){const g=_(),R=g-l;R>=Rt?l=g:R>=Bt&&(l=g,n(R),kt(r,o,window.innerWidth,window.innerHeight,b),tt(),Ut(),o.save(),s(),o.restore(),Object.keys(h.checked).forEach(et=>{delete h.checked[et],delete h.pressed[et]}),h.touched=!1),window.requestAnimationFrame(()=>{y(l)})}(),document.addEventListener("keydown",y=>{const l=y.key;h.holding[l]=!0,h.pressed[l]=!0}),document.addEventListener("keyup",y=>{const l=y.key;delete h.holding[l],delete h.pressed[l]}),document.addEventListener("touchstart",d),document.addEventListener("touchmove",d),document.addEventListener("touchend",w);function d(y){a.isMobile=!0,h.touched=!0;for(let l=0;l<y.changedTouches.length;l++){const g=y.changedTouches[l];h.touches[String(g.identifier)]=[g.pageX/b,g.pageY/b]}}function w(y){for(let l=0;l<y.changedTouches.length;l++){const g=y.changedTouches[l];delete h.touches[String(g.identifier)]}}function _(){return Date.now()/1e3}function tt(){a.width=Math.ceil(window.innerWidth/b),a.height=Math.ceil(window.innerHeight/b)}}function nt(i,t,e){const s=[],[n,r]=Mt(t,e);for(let o=0;o<i.height;o+=e)for(let d=0;d<i.width;d+=t){r.clearRect(0,0,t,e),r.drawImage(i,-d,-o);const w=new window.Image;w.src=n.toDataURL("image/png"),s.push(w)}return s}function rt(i){return new Promise((t,e)=>{const s=new window.Image;s.onload=()=>t(s),s.onerror=()=>e(new Error(`Failed to load image: '${i}'`)),s.src=i})}class St{static wasPressed(){return W.wasPressed(" ")||W.wasPressed("Enter")||v.wasTouched()}}class m{enter(t){}exit(){}render(){}update(t){}}const S={Speed:0,SpeedDC:1,Hp:2,HpDC:3,Attack:4,AttackDC:5},U=[19,13,1,7];function C(i){return U.concat(U,U).map((t,e)=>e<8?[t+i]:[t+i-1,t+i,t+i+1])}const Kt={player:{frames:C(84),frameInterval:.2,stats:[60,0,130,0,100,3]},princess:{frames:C(87),frameInterval:.2,stats:[60,0,1e3,0,0,0]},spirit1:{frames:C(60),frameInterval:.2,stats:[50,0,100,50,10,2]},spirit2:{frames:C(63),frameInterval:.2,stats:[50,0,100,50,10,2]}};class Jt{constructor(t,e){this.currentFrame=0,this.frames=t,this.frameTime=e,this.timer=0}getCurrentFrame(){return this.frames[this.currentFrame]}update(t){this.timer+=t,this.timer>=this.frameTime&&(this.timer-=this.frameTime,this.currentFrame=(this.currentFrame+1)%this.frames.length)}}class K extends m{constructor(t){super(),this.entity=t}enter(t){const e=this.entity;e.dx=0,e.dy=0,e.changeAnimation(e.direction+4)}}const X={Bottom:2,Left:3,Right:1,Top:0},Dt=["w","d","s","a"],j=[[0,-1],[1,0],[0,1],[-1,0]],c=16,Zt=5,at=70,ht=60,ot=.3,Qt=.3,z=.3,Nt=.2,M={buffer:null,current:null},Tt={};function qt(i){return new Promise(t=>{setTimeout(()=>t(window.zzfxM(...i)),20)})}async function $t(){const i=["death","7BMHBGJp1pLzcwfGX3oUr5AAx4BaegfyaxSbpHMiF9ccaB41RnGD94gGi2ZGMe7XnMPXNVnd8t5MMJNeSfBVUfyZbqzLtQUyoDUx1cEJKni316fXo1wWw1LUw","hit","11111JWCBmwPrHgUYTY22NTVVr8ELS4dgMRCWNP4ns8uo45dKynKrqe7XiR39QS5DwF1ZSCPsFYYHsbLxajA7FBbsV5jBCaoUFRpTiHyCRTDSiKu5riJiJrj","laser","11111391dYeYMXRc68xUWiTmo4EknU8mxy28cRaz1XUJJN9LuCb38Z2VWXsiz2M2thZ84fV6jSV6rFeyffQ5cBNvDZUg74Ts4Lhz4Pd4aMLyzLehW7AugyUB","powerup","11111Ho5khiTQRjKTZGV85Lnkbu4eiX47XdQgTHxoBFpKR9maAsSaxoU3ecGMpQhzastitBEGd7KgWxpRjCWMDD2vW6Pk7QnK5abzbvCT8e9ZvtEVrZVyHuy"];for(let t=0;t<i.length;t+=2)setTimeout(()=>{Tt[i[t]]=window.sfxr.toAudio(i[t+1])});M.buffer=await qt([[[1.8,0,72,,,.2,,4,-2,6,50,.15,,6],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[1.2,0,23,,,.2,3,4,,,3,.9,.05],[1.5,0,740,,,.15,2,.2,-.1,-.15,9,.02,,.1,.12,,.06]],[[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,,,,,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,25,,,25,,25,25,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,]],[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,8,8,8,5,13],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,,,,,,,,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13]],[[3,-1,13,13,13,8,13,,13,15,17,17,15,13,20,20,18,17,18,,,,17,,15,,,,17,,18,,22,22,22,,18,,,,25,25,25,,22,,,18,20,22,20,,,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,11,,23,,11,11,23,11,,11,23,11,11,11,23,,10,,22,,10,10,22,10,,10,22,10,10,6,8,10,20,25,20,20,25,20,,20,25,20,20,20,25,,20,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,15,13,,17,15,13,,15,,,,10,13,15,10,13,15,10,13,15,10,13,15,12,,,,,,8,15,,,,,17,15,13,8,13,,,,,,10,8,,20,20,20,20,20,20,20],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,15,,27,,15,15,27,15,,15,27,15,15,15,27,32,20,,32,,20,20,32,20,,20,32,20,20,20,32,,13,,25,,13,13,25,20,,20,32,20,20,20,32,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[2,-1,13,,25,25,13,,25,25,13,,25,25,13,,25,25,15,,27,27,15,,27,27,15,,27,27,15,,27,27,20,,32,32,20,,32,32,20,,32,32,20,,32,32,13,,25,25,13,,25,25,20,,32,32,20,,32,34],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,25,,,25,,,,25,25,25,25,25],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13,,13,13,13,13,13,13,13]]],[0,1,2,2,3,3,2,2,4,4,5,6,6,7,2,2,3]])}function J(i){xt(Tt[i]).play()}function _t(){M.current!=null?(M.current.stop(),M.current=null):M.current=window.zzfxP(...M.buffer)}class H extends m{constructor(t){super(),this.entity=t}enter(t){const e=this.entity;e.dx=0,e.dy=0,e.isCollidable=!1,e.isSolid=!1,e.changeAnimation(e.direction),this.timer=0,J("death")}update(t){this.timer+=t,this.timer>Nt&&(this.entity.isDestroyed=!0)}}class Z extends m{constructor(t){super(),this.entity=t}enter(t){const e=this.entity;e.dx=0,e.dy=0,e.changeAnimation(e.direction+4)}}class Q extends m{constructor(t){super(),this.entity=t}enter(t){const e=this.entity;e.changeAnimation(e.direction+8)}}const f=[],L=[];function O(i,t){t.forEach(e=>i.push(e))}class Ct{constructor(t){this.x=t.x??0,this.y=t.y??0,this.width=t.width??c,this.height=t.height??c,this.dx=0,this.dy=0,this.isCollidable=!!t.isCollidable,this.isDestroyed=!1,this.isSolid=!!t.isSolid,this.tileOX=t.tileOX??0,this.tileOY=t.tileOY??0,this.tileID=t.tileID}render(){this.tileID!=null&&bt(L[this.tileID],this.x+this.tileOX,this.y+this.tileOY)}update(t){this.x+=this.dx*t,this.y+=this.dy*t}centerX(){return this.x+.5*this.width}centerY(){return this.y+.5*this.height}collided(t){}retreate(t){this.x-=this.dx*t,this.y-=this.dy*t}}class N extends Ct{}function Xt(i,t,e,s){return i=i/s,e*i*i*i+t}function Et(i,t,e,s){return i=i/s-1,e*(i*i*i+1)+t}function te(i,t,e,s){return-e/2*(Math.cos(Math.PI*i/s)-1)+t}const ee=["#fff","#d72744","#79c834"];class It extends N{constructor(t){super({x:t.x,y:t.y}),this.color=t.color??0,this.damage=t.damage,this.timer=0}render(){const t=Xt(this.timer,this.y,-.5*c,ot);u(ee[this.color]),x(8),p(String(this.damage),this.x,t)}update(t){this.timer+=t,this.timer>=ot&&(this.isDestroyed=!0)}}class F extends m{constructor(t){super(),this.current=new m,this.states=t}change(t,e){this.current.exit(),this.current=this.states[t](),this.current.enter(e)}render(){this.current.render()}update(t){this.current.update(t)}}class q extends Ct{constructor(t){super({height:14,width:10,tileOX:-3,tileOY:-2,...t});const e=Kt[t.character];this.animations=this.genAnimations(e),this.currentAnimation=this.animations[6],this.direction=2,this.state=new F({death:()=>new H(this),idle:()=>new K(this),stunned:()=>new Z(this),walk:()=>new Q(this)}),this.state.change("idle"),this.exp=0,this.level=1,this.stats=e.stats.slice()}render(){this.state.current instanceof H?(u("#fff",.5),super.render(),u("#fff")):super.render()}update(t){this.currentAnimation?.update(t),this.tileID=this.currentAnimation?.getCurrentFrame(),this.state.update(t),super.update(t)}changeAnimation(t){this.currentAnimation=this.animations[t]}changeState(t,e){this.state.change(t,e)}genAnimations(t){return t.frames.map(e=>new Jt(e,t.frameInterval))}levelUp(){for(let t=0;t<this.stats.length;t+=2){const e=this.stats[t+1];for(let s=0;s<3;s++)A(6)<e&&this.stats[t]++}}takeDamage(t,e,s,n){this.stats[S.Hp]-=t,this.stats[S.Hp]<=0&&this.changeState("death"),this.entities.push(new It({x:e,y:s,color:n,damage:t}))}}class Yt{constructor(t){const e=Math.min(200,.6*a.width),s=Math.min(100,.6*a.height);this.x=t.x??.5*(a.width-e),this.y=t.y??.5*(a.height-s),this.width=t.width??e,this.height=t.height??s}}class vt extends Yt{render(){u("#fff",.75),V("fill",this.x,this.y,this.width,this.height,5)}}class ie{constructor(){this.metrics=[],this.panel=new vt({x:10,y:30,width:60,height:10})}render(){const t=.5*this.metrics.length;this.panel.height=10*t+10,this.panel.render(),u("#131313"),x(8);for(let e=0;e<this.metrics.length;e+=2)p(`${this.metrics[e]}: ${this.metrics[e+1]}`,15,this.panel.y+5*(e+1))}update(t){this.metrics=["vw",a.width,"vh",a.height]}}class Pt extends Yt{constructor(t){super(t),this.title=t.title,this.body=Array.isArray(t.body)?t.body:[t.body],this.bodyColor=t.bodyColor??"#000"}render(){const t=.5*(this.height-10*(this.body.length+3));u("#9f1d33"),x(12),p(this.title,this.x,this.y+t,this.width,"center"),x(8),u(this.bodyColor),this.body.forEach((e,s)=>p(e,this.x+4,this.y+t+10*s+30,this.width-8,this.body.length>1?"left":"center"))}}class se extends m{constructor(t){super(),this.panel=new vt(t),this.textbox=new Pt(t),this.fn=t.handler??P}render(){this.panel.render(),this.textbox.render()}update(t){St.wasPressed()&&(f[0].pop(),this.fn())}}class ne extends K{enter(t){super.enter(t)}update(t){const e=this.entity,s=e.entities[0],n=Zt*c;Math.abs(e.x-s.x)<n&&Math.abs(e.y-s.y)<n&&this.entity.changeState("walk")}}class re extends Q{enter(t){if(this.timer=0,t!=="flee"){const e=this.entity,s=e.entities[0],n=e.x-s.x,r=e.y-s.y;Math.abs(n)>Math.abs(r)?e.direction=n>0?X.Left:X.Right:e.direction=r>0?X.Top:X.Bottom;const o=j[e.direction];e.dx=o[0]*at,e.dy=o[1]*at}super.enter(t)}update(t){this.timer+=t,this.timer>=Qt&&this.entity.changeState("idle")}}const ct=["spirit1","spirit2"];class T extends q{constructor(t,e){super({x:t,y:e,isCollidable:!0,character:ct[A(ct.length)]}),this.state=new F({death:()=>new H(this),idle:()=>new ne(this),stunned:()=>new Z(this),walk:()=>new re(this)}),this.state.change("idle")}}const At=7,k=20,G=1.3*(k-At),dt=1,lt=3;class ae{constructor(){this.isVisible=a.isMobile,this.reset()}render(){this.isVisible&&(u("rgba(255, 255, 255, 0.4)"),it("line",this.x,this.y,k),it("fill",this.x+this.offsetX,this.y+this.offsetY,At))}update(t){if(this.x=a.width-1.5*k,this.y=a.height-1.5*k,this.touchID){const s=v.getPosition(this.touchID);if(s==null){this.reset();return}this.offsetX=ut(s[0],this.x),this.offsetY=ut(s[1],this.y),this.direction=he(this.offsetX,this.offsetY);return}const e=v.getTouches();e.length>0&&(this.isVisible=!0),e.some(s=>{const n=v.getPosition(s);return n!=null&&Math.abs(n[0]-this.x)<k&&Math.abs(n[1]-this.y)<k?(this.touchID=s,!0):!1})}reset(){this.offsetX=0,this.offsetY=0,this.direction=-1,this.touchID=null}}function he(i,t){return Math.abs(i)<dt&&(i=0),Math.abs(t)<dt&&(t=0),i===0&&t===0?-1:Math.abs(i)>=Math.abs(t)?i>0?1:3:t>0?2:0}function ut(i,t){const e=Ft(i-t,-G,G),s=Math.min(lt,Math.abs(e/G));return Et(s,0,e,lt)}class Wt extends N{constructor(t){const e=t.tileID;super({x:t.x,y:t.y,tileID:e,isSolid:oe(e)}),this.originalX=t.x,this.originalY=t.y}render(){super.render();const t=xt(this.tileID);t>=51&&t<=53&&bt(L[t-12],this.x,this.y-this.height)}}function oe(i){return i%12<7}class $ extends m{constructor(t){super(),this.entity=t}}class ce extends ${update(t){const e=this.entity,s=j[e.direction],n=1.5*c,r=e.centerX()+s[0]*(.5*e.width+n),o=e.centerY()+s[1]*(.5*e.height+n),d=e.entities.filter(w=>!(!(w instanceof T)||Math.abs(w.centerX()-r)>n||Math.abs(w.centerY()-o)>n));d.length>0&&e.blasterWeapon.change("fire",d[0])}}class de extends ${enter(){this.timer=0,this.timerDuration=.5}update(t){this.timer+=t,this.timer>=this.timerDuration&&this.entity.blasterWeapon.change("aim")}}class jt extends N{constructor(t){super({x:t.x,y:t.y,width:t.size??1,height:t.size??1,isCollidable:!0,isSolid:!1}),this.dx=t.dx,this.dy=t.dy,this.startX=t.x,this.startY=t.y,this.damage=t.damage}render(){u("red"),Ot(this.startX,this.startY,this.x,this.y)}update(t){super.update(t),Math.max(Math.abs(this.startX-this.x),Math.abs(this.startY-this.y))>=3*c&&(this.isDestroyed=!0)}collided(t){t instanceof T&&t.takeDamage(this.damage,this.x,this.y,2)}}class le extends ${enter(t){const e=this.entity;if(!(t instanceof T))throw new Error("expected enemy");const s=t.centerX()-e.centerX(),n=t.centerY()-e.centerY(),r=Math.max(Math.abs(s),Math.abs(n));e.entities.push(new jt({x:e.centerX(),y:e.centerY(),dx:s/r*240,dy:n/r*240,damage:e.stats[S.Attack]})),e.blasterWeapon.change("cooldown"),J("laser")}}class ue extends K{update(t){const e=this.entity.joystick,s=e.direction>-1?e.direction:Dt.findIndex(n=>W.wasPressed(n));s>-1&&(this.entity.direction=s,this.entity.changeState("walk")),super.update(t)}}class fe extends Q{update(t){const e=this.entity.joystick,s=e.direction>-1?e.direction:Dt.findIndex(r=>W.wasHolding(r)),n=this.entity;s>-1?(n.direction=s,n.dx=j[s][0]*ht,n.dy=j[s][1]*ht,n.changeAnimation(n.direction+8)):n.changeState("idle")}}class me extends q{constructor(t,e){super({x:t,y:e,isCollidable:!0,isSolid:!0,character:"player"}),this.state=new F({death:()=>new H(this),idle:()=>new ue(this),stunned:()=>new Z(this),walk:()=>new fe(this)}),this.state.change("idle"),this.blasterWeapon=new F({aim:()=>new ce(this),cooldown:()=>new de(this),fire:()=>new le(this)}),this.blasterWeapon.change("aim"),this.invulnerableTimer=0}render(){const t=te(z-this.invulnerableTimer,0,1,z);u("#fff",t),super.render(),u("#fff")}update(t){this.invulnerableTimer=Math.max(0,this.invulnerableTimer-t),this.blasterWeapon.update(t),super.update(t)}collided(t){t instanceof T&&this.invulnerableTimer===0&&(this.invulnerableTimer=z,this.takeDamage(t.stats[S.Attack],this.centerX(),this.centerY(),1),J("hit"))}}class B extends m{static check(){ft()&&f[0].push(new B)}render(){u("#322c7d"),V("fill",0,0,a.width,a.height),u("#fff"),x(16);let t=.5*a.height-60;"Please use landscape mode".split(" ").forEach(e=>p(e,8,t=t+20))}update(t){ft()||f[0].pop()}}function ft(){return .64*a.height>a.width}const E=[800,21,1700,0,201,27,401,29,601,30,801,21,1001,27,1101,46,1201,29,1401,26,1601,11,202,58,502,46,802,21,902,47,1202,58,203,30,303,45,403,26,803,19,1203,25,1303,47,1403,27,1503,58,704,8,804,9,904,10,1304,7,1404,21,1504,21,1604,21,105,21,205,21,305,7,405,21,505,21,705,20,805,21,905,22,1105,21,1205,21,106,58,706,32,806,33,906,34,1506,11,207,28,407,26,1007,26,1207,28,1407,30,1607,45,8,49,508,58,808,21,1508,53,9,0,109,25,209,27,309,51,409,30,609,28,809,21,909,44,1009,25,1109,27,1209,30,1309,37,1409,26,1609,50,1709,51],I=18,Y=10;class ye{constructor(){this.setViewport(),this.offsetX=this.startX(),this.offsetY=this.startY(),this.repeat=Math.ceil(Math.max(this.viewportWidth/I,this.viewportHeight/Y)),this.obstacles=[],this.terrain=[];for(let t=0;t<this.repeat;t++)for(let e=0;e<this.repeat;e++)for(let s=0;s<E.length;s+=2){const n=(Math.floor(E[s]/100)+e*I)*c,r=(E[s]%100+t*Y)*c,o=E[s+1],d=new Wt({x:n,y:r,tileID:o});(d.isSolid?this.obstacles:this.terrain).push(d)}this.updateMap()}render(){this.terrain.forEach(t=>t.render())}update(t){this.setViewport()}renderBg(){u("#000023"),V("fill",0,0,a.width,a.height)}setViewport(){this.viewportWidth=Math.ceil(a.width/c),this.viewportHeight=Math.ceil(a.height/c)}startX(){return .5*(I-this.viewportWidth)*c}startY(){return .5*(Y-this.viewportHeight)*c+c}updateObstacles(t,e){const s=I*this.repeat*c,n=Y*this.repeat*c;t.forEach(r=>{wt(r,e,c)||(r.x=mt(r.x,s,e.x,e.width),r.y=mt(r.y,n,e.y,e.height))})}updateMap(){const t={x:this.offsetX,y:this.offsetY,width:this.viewportWidth*c,height:this.viewportHeight*c};this.updateObstacles(this.obstacles,t),this.updateObstacles(this.terrain,t)}updateViewpoint(t,e){(this.offsetX!==t||this.offsetY!==e)&&(this.offsetX=t,this.offsetY=e,this.updateMap())}}function mt(i,t,e,s){return i<e-c?i+t:i>e+s?i-t:i}const ge="#28314A",yt=.4;class D extends m{static transitionTo(t){f[0].push(new D({fadeIn:!0,handler:()=>{f[0].pop(),f[0].push(t),f[0].push(new D({fadeIn:!1}))}}))}constructor(t){super(),this.fadeIn=t.fadeIn,this.easing=t.fadeIn?Xt:Et,this.opacity=t.fadeIn?0:1,this.timer=0,this.fn=t.handler??P}render(){u(ge,this.opacity),V("fill",0,0,a.width,a.height)}update(t){this.timer+=t,this.opacity=this.easing(this.timer,this.fadeIn?0:1,this.fadeIn?1:-1,yt),this.timer>=yt&&(f[0].pop(),this.fn())}}class pe extends m{enter(){this.tileMap=new ye,this.cameraX=this.tileMap.startX(),this.cameraY=this.tileMap.startY();const t=this.player=new me(8*c+3,5*c);this.entities=[t].concat(this.tileMap.obstacles),this.genEnemies(),this.console=new ie,this.joystick=new ae,t.entities=this.entities,t.joystick=this.joystick}render(){this.tileMap.renderBg(),st(-this.cameraX,-this.cameraY),this.tileMap.render(),we(this.entities).forEach(e=>e.render()),st(this.cameraX,this.cameraY),x(8);const t=.1*this.player.stats[S.Hp];p("❤️".repeat(Math.min(10,t)),5,5),t>10&&p("❤️".repeat(t-10),5,15),this.console.render(),this.joystick.render()}update(t){B.check(),this.console.update(t),this.joystick.isVisible&&this.console.metrics.push("ox",this.joystick.offsetX.toFixed(2),"oy",this.joystick.offsetY.toFixed(2),"jd",this.joystick.direction),this.joystick.update(t),this.tileMap.update(t),Lt(this.entities,(n,r)=>{n.update(t),n.isDestroyed&&this.entities.splice(r,1)});const e=this.entities.filter(n=>n.isCollidable||n.isSolid);e.forEach((n,r)=>{for(let o=r+1;o<e.length;++o){const d=e[o];wt(n,d,1)&&(n.isSolid&&d.isSolid&&(n.retreate(t),d.retreate(t)),n.isCollidable&&d.isCollidable&&(n.collided(d),d.collided(n)))}});const s=this.entities[0];this.cameraX=this.updateCamera(this.cameraX,s.x,.3*a.width,.7*a.width),this.cameraY=this.updateCamera(this.cameraY,s.y,.3*a.height,.7*a.height),this.tileMap.updateViewpoint(this.cameraX,this.cameraY),this.player.isDestroyed&&f[0].push(new se({title:"Game Over",body:"Do better next time!",handler:()=>D.transitionTo(new Ht(1))}))}genEnemies(){for(let t=0;t<10;++t){const e=new T(A(c,18*c),A(c,9*c));e.entities=this.entities,this.entities.push(e)}}updateCamera(t,e,s,n){return e<t+s?e-s:e>t+n?e-n:t}}function gt(i){return i instanceof q||i instanceof Wt?1:i instanceof jt?2:i instanceof It?3:0}function we(i){return i.slice().sort((t,e)=>{const s=gt(t),n=gt(e);return s!==n?s-n:t.y-e.y})}const pt="Spirit Hunter";class Ht extends m{constructor(t){super(),this.page=t??0}render(){switch(this.page){case 0:{u("#9F1D33"),x(24),p(pt,0,.5*a.height-32,null,"center"),u("#fff"),x(12),p("Press to ENTER start",0,.5*a.height+16,null,"center");break}case 1:{new Pt({title:pt,body:["Controls:","",a.isMobile?"Use joystick to":"Use W,A,S,D keys to","move the character"],bodyColor:"#fff"}).render();break}}}update(t){B.check(),St.wasPressed()&&(this.page<1?this.page++:(D.transitionTo(new pe),_t()))}}class xe{constructor(){this.stack=[]}pop(){this.stack[this.stack.length-1].exit(),this.stack.pop()}push(t){t.enter(),this.stack.push(t)}render(){this.stack.forEach(t=>t.render())}update(t){this.stack[this.stack.length-1].update(t)}}async function be(){O(L,nt(await rt("./tilemap2.png"),16,16)),O(L,nt(await rt("./characters2.png"),16,16)),await $t(),O(f,[new xe]),f[0].push(new Ht)}function Me(i){f[0].update(i)}function ke(){f[0].render()}Gt(be,Me,ke);