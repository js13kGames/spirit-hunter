document.write('<!doctype html><html lang=en><meta charset=UTF-8><meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" name=viewport><title>Spirit Hunter</title><link href=./game.css rel=stylesheet>');function Qt(t,e,i=0){return!(t.x>e.x+e.width-i||t.x+t.width<e.x+i||t.y>e.y+e.height-i||t.y+t.height<e.y+i)}function _t(){}function Me(t,e){for(let i=t.length;i--;)e(t[i],i,t)}function $t(t){if(t==null)throw new Error("");return t}function lt(t,e){return e==null&&(e=t,t=0),Math.floor(Math.random()*(e-t))+t}function xe(t,e,i){return Math.min(i,Math.max(e,t))}const ve=60,qe=1/ve,ke=1,V=3,l={context:null,checked:{},holding:{},pressed:{},touched:!1,touches:{}};function Se(){const t=l.context;t.clearRect(0,0,t.canvas.width,t.canvas.height)}function Rt(t,e,i,n){const r=l.context;r.beginPath(),r.arc(e,i,n,0,2*Math.PI),t==="fill"?r.fill():r.stroke()}function te(t,e,i){l.context.drawImage(t,Math.floor(e),Math.floor(i))}function Fe(t){return l.context.measureText(t).width}function Ce(t,e,i,n){const r=l.context;r.beginPath(),r.moveTo(t,e),r.lineTo(i,n),r.stroke()}function Y(t,e,i,n,r){const h=l.context;n=n??u.width-e;const a=Fe(t),p=r==="right"?n-a:r==="center"?.5*(n-a):0;h.fillText(t,Math.floor(e+p),Math.floor(i),n)}function Mt(t,e,i,n,r,h){const a=l.context;a.beginPath(),a.roundRect(Math.floor(e),Math.floor(i),Math.floor(n),Math.floor(r),h??0),a.fill()}function k(t,e){const i=l.context;i.fillStyle=t,i.strokeStyle=t,i.globalAlpha=e??1}function L(t){const e=l.context;e.font=typeof t=="number"?e.font.replace(/\d+/,String(t)):t}function Ot(t,e){l.context.translate(Math.floor(t),Math.floor(e))}function ee(t,e,i=1){const n=document.createElement("canvas"),r=n.getContext("2d");return ie(n,r,t,e,i),[n,r]}function ie(t,e,i,n,r=1){t.width===i&&t.height===n||(t.width=i,t.height=n,e.imageSmoothingEnabled=!1,e.font="8px Consolas, monaco, monospace",e.textBaseline="top",e.scale(r,r))}const u={isMobile:!1,width:0,height:0},dt={wasHolding(t){return l.holding[t]===!0},wasPressed(t){return l.pressed[t]===!0?(l.checked[t]=!0,!0):!1}},ut={getPosition(t){return l.touches[t]??null},getTouches(){return Object.keys(l.touches)},wasTouched(){return l.touched}};async function Pe(t,e,i){d(),t!=null&&await t();const n=i??_t,r=e??_t,[h,a]=ee(window.innerWidth,window.innerHeight,V);document.body?.appendChild(h),l.context=a,function m(f=w()){const x=w(),S=x-f;S>=ke?f=x:S>=qe&&(f=x,r(S),ie(h,a,window.innerWidth,window.innerHeight,V),d(),Se(),a.save(),n(),a.restore(),Object.keys(l.checked).forEach(P=>{delete l.checked[P],delete l.pressed[P]}),l.touched=!1),window.requestAnimationFrame(()=>{m(f)})}(),document.addEventListener("keydown",m=>{const f=m.key;l.holding[f]=!0,l.pressed[f]=!0}),document.addEventListener("keyup",m=>{const f=m.key;delete l.holding[f],delete l.pressed[f]}),document.addEventListener("touchstart",p),document.addEventListener("touchmove",p),document.addEventListener("touchend",c);function p(m){u.isMobile=!0,l.touched=!0;for(let f=0;f<m.changedTouches.length;f++){const x=m.changedTouches[f];l.touches[String(x.identifier)]=[x.pageX/V,x.pageY/V]}}function c(m){for(let f=0;f<m.changedTouches.length;f++){const x=m.changedTouches[f];delete l.touches[String(x.identifier)]}}function w(){return Date.now()/1e3}function d(){u.width=Math.ceil(window.innerWidth/V),u.height=Math.ceil(window.innerHeight/V)}}function zt(t,e,i){const n=[],[r,h]=ee(e,i);for(let a=0;a<t.height;a+=i)for(let p=0;p<t.width;p+=e){h.clearRect(0,0,e,i),h.drawImage(t,-p,-a);const c=new window.Image;c.src=r.toDataURL("image/png"),n.push(c)}return n}function Xt(t){return new Promise((e,i)=>{const n=new window.Image;n.onload=()=>e(n),n.onerror=()=>i(new Error(`Failed to load image: '${t}'`)),n.src=t})}class ne{static wasPressed(){return dt.wasPressed(" ")||dt.wasPressed("Enter")||ut.wasTouched()}}class I{enter(e){}exit(){}render(){}update(e){}}const Q={Speed:0,SpeedDC:1,Hp:2,HpDC:3,Attack:4,AttackDC:5},vt=[19,13,1,7];function st(t){return vt.concat(vt,vt).map((e,i)=>i<8?[e+t]:[e+t-1,e+t,e+t+1])}const Te={player:{frames:st(84),frameInterval:.2,stats:[60,0,130,0,100,3]},princess:{frames:st(87),frameInterval:.2,stats:[60,0,1e3,0,0,0]},spirit1:{frames:st(60),frameInterval:.2,stats:[50,0,100,50,10,2]},spirit2:{frames:st(63),frameInterval:.2,stats:[50,0,100,50,10,2]}};class Ie{constructor(e,i){this.currentFrame=0,this.frames=e,this.frameTime=i,this.timer=0}getCurrentFrame(){return this.frames[this.currentFrame]}update(e){this.timer+=e,this.timer>=this.frameTime&&(this.timer-=this.frameTime,this.currentFrame=(this.currentFrame+1)%this.frames.length)}}class Ct extends I{constructor(e){super(),this.entity=e}enter(e){const i=this.entity;i.dx=0,i.dy=0,i.changeAnimation(i.direction+4)}}const rt={Bottom:2,Left:3,Right:1,Top:0},se=["w","d","s","a"],mt=[[0,-1],[1,0],[0,1],[-1,0]],y=16,Ae=5,Yt=70,Bt=60,Lt=.3,Ee=.3,qt=.3,De=.2,re={chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encLookup:[],Init:function(){for(let t=0;t<4096;t++)this.encLookup[t]=this.chars[t>>6]+this.chars[t&63]},Encode:function(t){let e=t.length,i="",n=0;for(;e>2;){const r=t[n]<<16|t[n+1]<<8|t[n+2];i+=this.encLookup[r>>12]+this.encLookup[r&4095],e-=3,n+=3}if(e>0){const r=(t[n]&252)>>2;let h=(t[n]&3)<<4;if(e>1&&(h|=(t[++n]&240)>>4),i+=this.chars[r],i+=this.chars[h],e===2){let a=(t[n++]&15)<<2;a|=(t[n]&192)>>6,i+=this.chars[a]}e===1&&(i+="="),i+="="}return i}};re.Init();function Re(t){this.data=[],this.wav=[],this.dataURI="",this.header={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:8e3,byteRate:0,blockAlign:0,bitsPerSample:8,subChunk2Id:[100,97,116,97],subChunk2Size:0};function e(n){return[n&255,n>>8&255,n>>16&255,n>>24&255]}function i(n){return[n&255,n>>8&255]}this.Make=function(n){n instanceof Array&&(this.data=n),this.header.byteRate=this.header.sampleRate*this.header.numChannels*this.header.bitsPerSample>>3,this.header.blockAlign=this.header.numChannels*this.header.bitsPerSample>>3,this.header.subChunk2Size=this.data.length,this.header.chunkSize=36+this.header.subChunk2Size,this.wav=this.header.chunkId.concat(e(this.header.chunkSize),this.header.format,this.header.subChunk1Id,e(this.header.subChunk1Size),i(this.header.audioFormat),i(this.header.numChannels),e(this.header.sampleRate),e(this.header.byteRate),i(this.header.blockAlign),i(this.header.bitsPerSample),this.header.subChunk2Id,e(this.header.subChunk2Size),this.data),this.dataURI="data:audio/wav;base64,"+re.Encode(this.wav)},t instanceof Array&&this.Make(t)}const J=0,K=1,it=2,$=3,Oe=1,at=8;function v(){this.oldParams=!0,this.wave_type=J,this.p_env_attack=0,this.p_env_sustain=.3,this.p_env_punch=0,this.p_env_decay=.4,this.p_base_freq=.3,this.p_freq_limit=0,this.p_freq_ramp=0,this.p_freq_dramp=0,this.p_vib_strength=0,this.p_vib_speed=0,this.p_arp_mod=0,this.p_arp_speed=0,this.p_duty=0,this.p_duty_ramp=0,this.p_repeat_speed=0,this.p_pha_offset=0,this.p_pha_ramp=0,this.p_lpf_freq=1,this.p_lpf_ramp=0,this.p_lpf_resonance=0,this.p_hpf_freq=0,this.p_hpf_ramp=0,this.sound_vol=.5,this.sample_rate=44100,this.sample_size=8}function yt(t){return t*t}function Wt(t){return t*t*t}function s(t){return Math.random()*t}function N(t,e){return Math.random()*(e-t)+t}function o(t){return Math.floor(Math.random()*(t+1))}function ht(t,e,i){return t<<31|e<<23|i}function ze(t){if(isNaN(t))return ht(0,255,4919);const e=t<0?1:0;if(t=Math.abs(t),t==0)return ht(e,0,0);const i=Math.floor(Math.log(t)/Math.LN2);if(i>127||i<-126)return ht(e,255,0);const n=t/Math.pow(2,i);return ht(e,i+127,n*Math.pow(2,23)&8388607)}function Xe(t){const e=t&2147483648?-1:1;let i=(t>>23&255)-127,n=t&~(-1<<23);if(i==128)return e*(n?Number.NaN:Number.POSITIVE_INFINITY);if(i==-127){if(n==0)return e*0;i=-126,n/=1<<22}else n=(n|1<<23)/(1<<23);return e*n*Math.pow(2,i)}const ae="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",tt=["wave_type","p_env_attack","p_env_sustain","p_env_punch","p_env_decay","p_base_freq","p_freq_limit","p_freq_ramp","p_freq_dramp","p_vib_strength","p_vib_speed","p_arp_mod","p_arp_speed","p_duty","p_duty_ramp","p_repeat_speed","p_pha_offset","p_pha_ramp","p_lpf_freq","p_lpf_ramp","p_lpf_resonance","p_hpf_freq","p_hpf_ramp"],Ye=["p_freq_ramp","p_freq_dramp","p_arp_mod","p_duty_ramp","p_pha_offset","p_pha_ramp","p_lpf_ramp","p_hpf_ramp"];v.prototype.toB58=function(){const t=[];for(const e in tt){const i=tt[e];if(i=="wave_type")t.push(this[i]);else if(i.indexOf("p_")==0){let n=this[i];n=ze(n),t.push(255&n),t.push(255&n>>8),t.push(255&n>>16),t.push(255&n>>24)}}return function(e,i){const n=[];let r="",h,a,p,c;for(h in e)for(a=0,p=e[h],r+=p||r.length^h?"":1;a in n||p;)c=n[a],c=c?c*256+p:p,p=c/58|0,n[a]=c%58,a++;for(;a--;)r+=i[n[a]];return r}(t,ae)};v.prototype.fromB58=function(t){return this.fromJSON(A.b58decode(t)),this};v.prototype.fromJSON=function(t){for(const e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);return this};v.prototype.pickupCoin=function(){return this.wave_type=K,this.p_base_freq=.4+s(.5),this.p_env_attack=0,this.p_env_sustain=s(.1),this.p_env_decay=.1+s(.4),this.p_env_punch=.3+s(.3),o(1)&&(this.p_arp_speed=.5+s(.2),this.p_arp_mod=.2+s(.4)),this};v.prototype.laserShoot=function(){return this.wave_type=o(2),this.wave_type===it&&o(1)&&(this.wave_type=o(1)),o(2)===0?(this.p_base_freq=.3+s(.6),this.p_freq_limit=s(.1),this.p_freq_ramp=-.35-s(.3)):(this.p_base_freq=.5+s(.5),this.p_freq_limit=this.p_base_freq-.2-s(.6),this.p_freq_limit<.2&&(this.p_freq_limit=.2),this.p_freq_ramp=-.15-s(.2)),this.wave_type===K&&(this.p_duty=1),o(1)?(this.p_duty=s(.5),this.p_duty_ramp=s(.2)):(this.p_duty=.4+s(.5),this.p_duty_ramp=-s(.7)),this.p_env_attack=0,this.p_env_sustain=.1+s(.2),this.p_env_decay=s(.4),o(1)&&(this.p_env_punch=s(.3)),o(2)===0&&(this.p_pha_offset=s(.2),this.p_pha_ramp=-s(.2)),this.p_hpf_freq=s(.3),this};v.prototype.explosion=function(){return this.wave_type=$,o(1)?(this.p_base_freq=yt(.1+s(.4)),this.p_freq_ramp=-.1+s(.4)):(this.p_base_freq=yt(.2+s(.7)),this.p_freq_ramp=-.2-s(.2)),o(4)===0&&(this.p_freq_ramp=0),o(2)===0&&(this.p_repeat_speed=.3+s(.5)),this.p_env_attack=0,this.p_env_sustain=.1+s(.3),this.p_env_decay=s(.5),o(1)&&(this.p_pha_offset=-.3+s(.9),this.p_pha_ramp=-s(.3)),this.p_env_punch=.2+s(.6),o(1)&&(this.p_vib_strength=s(.7),this.p_vib_speed=s(.6)),o(2)===0&&(this.p_arp_speed=.6+s(.3),this.p_arp_mod=.8-s(1.6)),this};v.prototype.powerUp=function(){return o(1)?(this.wave_type=K,this.p_duty=1):this.p_duty=s(.6),this.p_base_freq=.2+s(.3),o(1)?(this.p_freq_ramp=.1+s(.4),this.p_repeat_speed=.4+s(.4)):(this.p_freq_ramp=.05+s(.2),o(1)&&(this.p_vib_strength=s(.7),this.p_vib_speed=s(.6))),this.p_env_attack=0,this.p_env_sustain=s(.4),this.p_env_decay=.1+s(.4),this};v.prototype.hitHurt=function(){return this.wave_type=o(2),this.wave_type===it&&(this.wave_type=$),this.wave_type===J&&(this.p_duty=s(.6)),this.wave_type===K&&(this.p_duty=1),this.p_base_freq=.2+s(.6),this.p_freq_ramp=-.3-s(.4),this.p_env_attack=0,this.p_env_sustain=s(.1),this.p_env_decay=.1+s(.2),o(1)&&(this.p_hpf_freq=s(.3)),this};v.prototype.jump=function(){return this.wave_type=J,this.p_duty=s(.6),this.p_base_freq=.3+s(.3),this.p_freq_ramp=.1+s(.2),this.p_env_attack=0,this.p_env_sustain=.1+s(.3),this.p_env_decay=.1+s(.2),o(1)&&(this.p_hpf_freq=s(.3)),o(1)&&(this.p_lpf_freq=1-s(.6)),this};v.prototype.blipSelect=function(){return this.wave_type=o(1),this.wave_type===J?this.p_duty=s(.6):this.p_duty=1,this.p_base_freq=.2+s(.4),this.p_env_attack=0,this.p_env_sustain=.1+s(.1),this.p_env_decay=s(.2),this.p_hpf_freq=.1,this};v.prototype.synth=function(){return this.wave_type=o(1),this.p_base_freq=[.2723171360931539,.19255692561524382,.13615778746815113][o(2)],this.p_env_attack=o(4)>3?s(.5):0,this.p_env_sustain=s(1),this.p_env_punch=s(1),this.p_env_decay=s(.9)+.1,this.p_arp_mod=[0,0,0,0,-.3162,.7454,.7454][o(6)],this.p_arp_speed=s(.5)+.4,this.p_duty=s(1),this.p_duty_ramp=o(2)==2?s(1):0,this.p_lpf_freq=[1,.9*s(1)*s(1)+.1][o(1)],this.p_lpf_ramp=N(-1,1),this.p_lpf_resonance=s(1),this.p_hpf_freq=o(3)==3?s(1):0,this.p_hpf_ramp=o(3)==3?s(1):0,this};v.prototype.tone=function(){return this.wave_type=it,this.p_base_freq=.35173364,this.p_env_attack=0,this.p_env_sustain=.6641,this.p_env_decay=0,this.p_env_punch=0,this};v.prototype.click=function(){const t=["explosion","hitHurt"][o(1)];return this[t](),o(1)&&(this.p_freq_ramp=-.5+s(1)),o(1)&&(this.p_env_sustain=(s(.4)+.2)*this.p_env_sustain,this.p_env_decay=(s(.4)+.2)*this.p_env_decay),o(3)==0&&(this.p_env_attack=s(.3)),this.p_base_freq=1-s(.25),this.p_hpf_freq=1-s(.1),this};v.prototype.random=function(){return this.wave_type=o(3),o(1)?this.p_base_freq=Wt(s(2)-1)+.5:this.p_base_freq=yt(s(1)),this.p_freq_limit=0,this.p_freq_ramp=Math.pow(s(2)-1,5),this.p_base_freq>.7&&this.p_freq_ramp>.2&&(this.p_freq_ramp=-this.p_freq_ramp),this.p_base_freq<.2&&this.p_freq_ramp<-.05&&(this.p_freq_ramp=-this.p_freq_ramp),this.p_freq_dramp=Math.pow(s(2)-1,3),this.p_duty=s(2)-1,this.p_duty_ramp=Math.pow(s(2)-1,3),this.p_vib_strength=Math.pow(s(2)-1,3),this.p_vib_speed=N(-1,1),this.p_env_attack=Wt(N(-1,1)),this.p_env_sustain=yt(N(-1,1)),this.p_env_decay=N(-1,1),this.p_env_punch=Math.pow(s(.8),2),this.p_env_attack+this.p_env_sustain+this.p_env_decay<.2&&(this.p_env_sustain+=.2+s(.3),this.p_env_decay+=.2+s(.3)),this.p_lpf_resonance=N(-1,1),this.p_lpf_freq=1-Math.pow(s(1),3),this.p_lpf_ramp=Math.pow(s(2)-1,3),this.p_lpf_freq<.1&&this.p_lpf_ramp<-.05&&(this.p_lpf_ramp=-this.p_lpf_ramp),this.p_hpf_freq=Math.pow(s(1),5),this.p_hpf_ramp=Math.pow(s(2)-1,5),this.p_pha_offset=Math.pow(s(2)-1,3),this.p_pha_ramp=Math.pow(s(2)-1,3),this.p_repeat_speed=s(2)-1,this.p_arp_speed=s(2)-1,this.p_arp_mod=s(2)-1,this};v.prototype.mutate=function(){return o(1)&&(this.p_base_freq+=s(.1)-.05),o(1)&&(this.p_freq_ramp+=s(.1)-.05),o(1)&&(this.p_freq_dramp+=s(.1)-.05),o(1)&&(this.p_duty+=s(.1)-.05),o(1)&&(this.p_duty_ramp+=s(.1)-.05),o(1)&&(this.p_vib_strength+=s(.1)-.05),o(1)&&(this.p_vib_speed+=s(.1)-.05),o(1)&&(this.p_vib_delay+=s(.1)-.05),o(1)&&(this.p_env_attack+=s(.1)-.05),o(1)&&(this.p_env_sustain+=s(.1)-.05),o(1)&&(this.p_env_decay+=s(.1)-.05),o(1)&&(this.p_env_punch+=s(.1)-.05),o(1)&&(this.p_lpf_resonance+=s(.1)-.05),o(1)&&(this.p_lpf_freq+=s(.1)-.05),o(1)&&(this.p_lpf_ramp+=s(.1)-.05),o(1)&&(this.p_hpf_freq+=s(.1)-.05),o(1)&&(this.p_hpf_ramp+=s(.1)-.05),o(1)&&(this.p_pha_offset+=s(.1)-.05),o(1)&&(this.p_pha_ramp+=s(.1)-.05),o(1)&&(this.p_repeat_speed+=s(.1)-.05),o(1)&&(this.p_arp_speed+=s(.1)-.05),o(1)&&(this.p_arp_mod+=s(.1)-.05),this};const A={};A.toBuffer=function(t){return new W(t).getRawBuffer().buffer};A.toWebAudio=function(t,e){const i=new W(t),n=i.getRawBuffer().normalized;if(e){const r=e.createBuffer(1,n.length,i.sampleRate),h=r.getChannelData(0);for(let p=0;p<n.length;p++)h[p]=n[p];const a=e.createBufferSource();return a.buffer=r,a}};A.toWave=function(t){return new W(t).generate()};A.toAudio=function(t){return A.toWave(t).getAudio()};A.play=function(t){return A.toAudio(t).play()};A.b58decode=function(t){const e=function(n,r){const h=[],a=[];let p,c,w,d;for(p in n){if(c=0,w=r.indexOf(n[p]),w<0)return;for(w||a.length^p||a.push(0);c in h||w;)d=h[c],d=d?d*58+w:w,w=d>>8,h[c]=d%256,c++}for(;c--;)a.push(h[c]);return new Uint8Array(a)}(t,ae),i={};for(const n in tt){const r=tt[n],h=(n-1)*4+1;if(r=="wave_type")i[r]=e[0];else{const a=e[h]|e[h+1]<<8|e[h+2]<<16|e[h+3]<<24;i[r]=Xe(a)}}return i};A.b58encode=function(t){const e=new v;return e.fromJSON(t),e.toB58()};A.generate=function(t,e){const i=new v,n=e||{};return i.sound_vol=n.sound_vol||.25,i.sample_rate=n.sample_rate||44100,i.sample_size=n.sample_size||8,i[t]()};function W(t){if(typeof t=="string"){const e=new v;t.indexOf("#")==0&&(t=t.slice(1)),t=e.fromB58(t)}this.init(t)}W.prototype.init=function(t){this.parameters=t,this.initForRepeat(),this.waveShape=parseInt(t.wave_type),this.fltw=Math.pow(t.p_lpf_freq,3)*.1,this.enableLowPassFilter=t.p_lpf_freq!=1,this.fltw_d=1+t.p_lpf_ramp*1e-4,this.fltdmp=5/(1+Math.pow(t.p_lpf_resonance,2)*20)*(.01+this.fltw),this.fltdmp>.8&&(this.fltdmp=.8),this.flthp=Math.pow(t.p_hpf_freq,2)*.1,this.flthp_d=1+t.p_hpf_ramp*3e-4,this.vibratoSpeed=Math.pow(t.p_vib_speed,2)*.01,this.vibratoAmplitude=t.p_vib_strength*.5,this.envelopeLength=[Math.floor(t.p_env_attack*t.p_env_attack*1e5),Math.floor(t.p_env_sustain*t.p_env_sustain*1e5),Math.floor(t.p_env_decay*t.p_env_decay*1e5)],this.envelopePunch=t.p_env_punch,this.flangerOffset=Math.pow(t.p_pha_offset,2)*1020,t.p_pha_offset<0&&(this.flangerOffset=-this.flangerOffset),this.flangerOffsetSlide=Math.pow(t.p_pha_ramp,2)*1,t.p_pha_ramp<0&&(this.flangerOffsetSlide=-this.flangerOffsetSlide),this.repeatTime=Math.floor(Math.pow(1-t.p_repeat_speed,2)*2e4+32),t.p_repeat_speed===0&&(this.repeatTime=0),this.gain=Math.exp(t.sound_vol)-1,this.sampleRate=t.sample_rate,this.bitsPerChannel=t.sample_size};W.prototype.initForRepeat=function(){const t=this.parameters;this.elapsedSinceRepeat=0,this.period=100/(t.p_base_freq*t.p_base_freq+.001),this.periodMax=100/(t.p_freq_limit*t.p_freq_limit+.001),this.enableFrequencyCutoff=t.p_freq_limit>0,this.periodMult=1-Math.pow(t.p_freq_ramp,3)*.01,this.periodMultSlide=-Math.pow(t.p_freq_dramp,3)*1e-6,this.dutyCycle=.5-t.p_duty*.5,this.dutyCycleSlide=-t.p_duty_ramp*5e-5,t.p_arp_mod>=0?this.arpeggioMultiplier=1-Math.pow(t.p_arp_mod,2)*.9:this.arpeggioMultiplier=1+Math.pow(t.p_arp_mod,2)*10,this.arpeggioTime=Math.floor(Math.pow(1-t.p_arp_speed,2)*2e4+32),t.p_arp_speed===1&&(this.arpeggioTime=0)};W.prototype.getRawBuffer=function(){let t=0,e=0,i=0;const n=Array(32);for(var r=0;r<32;++r)n[r]=Math.random()*2-1;let h=0,a=0,p=0,c=0,w=0;const d=Array(1024);for(var r=0;r<1024;++r)d[r]=0;let m=0;const f=[],x=[];let S=0,P=0;const q=Math.floor(44100/this.sampleRate);for(let D=0;this.repeatTime!=0&&++this.elapsedSinceRepeat>=this.repeatTime&&this.initForRepeat(),this.arpeggioTime!=0&&D>=this.arpeggioTime&&(this.arpeggioTime=0,this.period*=this.arpeggioMultiplier),this.periodMult+=this.periodMultSlide,this.period*=this.periodMult,!(this.period>this.periodMax&&(this.period=this.periodMax,this.enableFrequencyCutoff));++D){let O=this.period;this.vibratoAmplitude>0&&(p+=this.vibratoSpeed,O=this.period*(1+Math.sin(p)*this.vibratoAmplitude));let M=Math.floor(O);if(M<at&&(M=at),this.dutyCycle+=this.dutyCycleSlide,this.dutyCycle<0&&(this.dutyCycle=0),this.dutyCycle>.5&&(this.dutyCycle=.5),++a>this.envelopeLength[h]&&(a=0,++h>2))break;var E;const z=a/this.envelopeLength[h];h===0?E=z:h===1?E=1+(1-z)*2*this.envelopePunch:E=1-z,this.flangerOffset+=this.flangerOffsetSlide;let X=Math.abs(Math.floor(this.flangerOffset));X>1023&&(X=1023),this.flthp_d!=0&&(this.flthp*=this.flthp_d,this.flthp<1e-5&&(this.flthp=1e-5),this.flthp>.1&&(this.flthp=.1));let _=0;for(let R=0;R<at;++R){let g=0;if(c++,c>=M&&(c%=M,this.waveShape===$))for(var r=0;r<32;++r)n[r]=Math.random()*2-1;const T=c/M;if(this.waveShape===J)T<this.dutyCycle?g=.5:g=-.5;else if(this.waveShape===K)T<this.dutyCycle?g=-1+2*T/this.dutyCycle:g=1-2*(T-this.dutyCycle)/(1-this.dutyCycle);else if(this.waveShape===it)g=Math.sin(T*2*Math.PI);else if(this.waveShape===$)g=n[Math.floor(c*32/M)];else throw"ERROR: Bad wave type: "+this.waveShape;const b=t;this.fltw*=this.fltw_d,this.fltw<0&&(this.fltw=0),this.fltw>.1&&(this.fltw=.1),this.enableLowPassFilter?(e+=(g-t)*this.fltw,e-=e*this.fltdmp):(t=g,e=0),t+=e,i+=t-b,i-=i*this.flthp,g=i,d[w&1023]=g,g+=d[w-X+1024&1023],w=w+1&1023,_+=g*E}if(S+=_,++P>=q)P=0,_=S/q,S=0;else continue;_=_/at*Oe,_*=this.gain,x.push(_),this.bitsPerChannel===8?(_=Math.floor((_+1)*128),_>255?(_=255,++m):_<0&&(_=0,++m),f.push(_)):(_=Math.floor(_*32768),_>=32768?(_=32767,++m):_<-32768&&(_=-32768,++m),f.push(_&255),f.push(_>>8&255))}return{buffer:f,normalized:x,clipped:m}};W.prototype.generate=function(){const t=this.getRawBuffer(),e=new Re;return e.header.sampleRate=this.sampleRate,e.header.bitsPerSample=this.bitsPerChannel,e.Make(t.buffer),e.clipping=t.clipped,e.buffer=t.normalized,e.getAudio=Be(e),e};let ot=null;function Be(t){return function(){let e=null;if(ot||("AudioContext"in window?ot=new AudioContext:"webkitAudioContext"in window&&(ot=new webkitAudioContext)),e=ot,e){const i=e.createBuffer(1,t.buffer.length,t.header.sampleRate),n=i.getChannelData(0);for(let a=0;a<t.buffer.length;a++)n[a]=t.buffer[a];let r=1;const h={channels:[],setVolume:function(a){return r=a,h},play:function(){const a=e.createBufferSource();a.buffer=i;const p=e.createGain();return p.gain.value=r,p.connect(e.destination),a.connect(p),a.start?a.start():a.noteOn&&a.noteOn(0),this.channels.push(a),a}};return h}else{const i=new Audio;return i.src=t.dataURI,i}}}const Le={p_env_attack:function(t){return t*t*1e5},p_env_sustain:function(t){return t*t*1e5},p_env_punch:function(t){return t},p_env_decay:function(t){return t*t*1e5},p_base_freq:function(t){return 8*44100*(t*t+.001)/100},p_freq_limit:function(t){return 8*44100*(t*t+.001)/100},p_freq_ramp:function(t){return 1-Math.pow(t,3)*.01},p_freq_dramp:function(t){return-Math.pow(t,3)*1e-6},p_vib_speed:function(t){return Math.pow(t,2)*.01},p_vib_strength:function(t){return t*.5},p_arp_mod:function(t){return t>=0?1-Math.pow(t,2)*.9:1+Math.pow(t,2)*10},p_arp_speed:function(t){return t===1?0:Math.floor(Math.pow(1-t,2)*2e4+32)},p_duty:function(t){return .5-t*.5},p_duty_ramp:function(t){return-t*5e-5},p_repeat_speed:function(t){return t===0?0:Math.floor(Math.pow(1-t,2)*2e4)+32},p_pha_offset:function(t){return(t<0?-1:1)*Math.pow(t,2)*1020},p_pha_ramp:function(t){return(t<0?-1:1)*Math.pow(t,2)},p_lpf_freq:function(t){return Math.pow(t,3)*.1},p_lpf_ramp:function(t){return 1+t*1e-4},p_lpf_resonance:function(t){return 5/(1+Math.pow(t,2)*20)},p_hpf_freq:function(t){return Math.pow(t,2)*.1},p_hpf_ramp:function(t){return 1+t*3e-4},sound_vol:function(t){return Math.exp(t)-1}},We={p_env_attack:function(t){return Math.sqrt(t/1e5)},p_env_sustain:function(t){return Math.sqrt(t/1e5)},p_env_punch:function(t){return t},p_env_decay:function(t){return Math.sqrt(t/1e5)},p_base_freq:function(t){return Math.sqrt(t*100/8/44100-.001)},p_freq_limit:function(t){return Math.sqrt(t*100/8/44100-.001)},p_freq_ramp:function(t){return Math.cbrt((1-t)/.01)},p_freq_dramp:function(t){return Math.cbrt(t/-1e-6)},p_vib_speed:function(t){return Math.sqrt(t/.01)},p_vib_strength:function(t){return t/.5},p_arp_mod:function(t){return t<1?Math.sqrt((1-t)/.9):-Math.sqrt((t-1)/10)},p_arp_speed:function(t){return t===0?1:1-Math.sqrt((t-(t<100?30:32))/2e4)},p_duty:function(t){return(t-.5)/-.5},p_duty_ramp:function(t){return t/-5e-5},p_repeat_speed:function(t){return t===0?0:-(Math.sqrt((t-32)/2e4)-1)},p_pha_offset:function(t){return(t<0?-1:1)*Math.sqrt(Math.abs(t)/1020)},p_pha_ramp:function(t){return(t<0?-1:1)*Math.sqrt(Math.abs(t))},p_lpf_freq:function(t){return Math.cbrt(t/.1)},p_lpf_ramp:function(t){return(t-1)/1e-4},p_lpf_resonance:function(t){return Math.sqrt((1/(t/5)-1)/20)},p_hpf_freq:function(t){return Math.sqrt(t/.1)},p_hpf_ramp:function(t){return(t-1)/3e-4},sound_vol:function(t){return Math.log(t+1)}},He={p_env_attack:function(t){return t/44100},p_env_sustain:function(t){return t/44100},p_env_punch:function(t){return t*100},p_env_decay:function(t){return t/44100},p_base_freq:function(t){return t},p_freq_limit:function(t){return t},p_freq_ramp:function(t){return 44100*Math.log(t)/Math.log(.5)},p_freq_dramp:function(t){return t*44100/Math.pow(2,-44101/44100)},p_vib_speed:function(t){return 441e3/64*t},p_vib_strength:function(t){return t*100},p_arp_mod:function(t){return 1/t},p_arp_speed:function(t){return t/44100},p_duty:function(t){return 100*t},p_duty_ramp:function(t){return 8*44100*t},p_repeat_speed:function(t){return t===0?0:44100/t},p_pha_offset:function(t){return 1e3*t/44100},p_pha_ramp:function(t){return 1e3*t},p_lpf_freq:function(t){return t===.1?0:8*44100*t/(1-t)},p_lpf_ramp:function(t){return Math.pow(t,44100)},p_lpf_resonance:function(t){return 100*(1-t*.11)},p_hpf_freq:function(t){return 8*44100*t/(1-t)},p_hpf_ramp:function(t){return Math.pow(t,44100)},sound_vol:function(t){return 10*Math.log(t*t)/Math.log(10)}},je={p_env_attack:function(t){return t*44100},p_env_sustain:function(t){return t*44100},p_env_punch:function(t){return t/100},p_env_decay:function(t){return t*44100},p_base_freq:function(t){return t},p_freq_limit:function(t){return t},p_freq_ramp:function(t){return Math.exp(Math.log(.5)*t/44100)},p_freq_dramp:function(t){return t*Math.pow(2,-44101/44100)/44100},p_vib_speed:function(t){return 64/441e3*t},p_vib_strength:function(t){return t/100},p_arp_mod:function(t){return 1/t},p_arp_speed:function(t){return t*44100},p_duty:function(t){return t/100},p_duty_ramp:function(t){return t/(8*44100)},p_repeat_speed:function(t){return t<=0?0:t>1378?32:44100/t},p_pha_offset:function(t){return t/1e3*44100},p_pha_ramp:function(t){return t/1e3},p_lpf_freq:function(t){return t/(t+8*44100)},p_lpf_ramp:function(t){return Math.pow(t,1/44100)},p_lpf_resonance:function(t){return(1-t/100)/.11},p_hpf_freq:function(t){return t/(t+8*44100)},p_hpf_ramp:function(t){return Math.pow(t,1/44100)},sound_vol:function(t){return Math.sqrt(Math.pow(10,t/10))}},Ve={p_env_attack:function(t){return(t/44100).toPrecision(4)+" sec"},p_env_sustain:function(t){return(t/44100).toPrecision(4)+" sec"},p_env_punch:function(t){return"+"+(t*100).toPrecision(4)+"%"},p_env_decay:function(t){return(t/44100).toPrecision(4)+" sec"},p_base_freq:function(t){return t.toPrecision(4)+"Hz"},p_freq_limit:function(t){return t.toPrecision(4)+"Hz"},p_freq_ramp:function(t){return(44100*Math.log(t)/Math.log(.5)).toPrecision(4)+" 8va/sec"},p_freq_dramp:function(t){return(t*44100/Math.pow(2,-44101/44100)).toExponential(4)+" 8va/s^2"},p_vib_speed:function(t){return t===0?"OFF":(441e3/64*t).toPrecision(4)+" Hz"},p_vib_strength:function(t){return t===0?"OFF":"&plusmn; "+(t*100).toPrecision(4)+"%"},p_arp_mod:function(t){return t===1?"OFF":"x "+(1/t).toPrecision(4)},p_arp_speed:function(t){return t===0?"OFF":(t/44100).toPrecision(4)+" sec"},p_duty:function(t){return(100*t).toPrecision(4)+"%"},p_duty_ramp:function(t){return(8*44100*t).toPrecision(4)+"%/sec"},p_repeat_speed:function(t){return t===0?"OFF":(44100/t).toPrecision(4)+" Hz"},p_pha_offset:function(t){return t===0?"OFF":(1e3*t/44100).toPrecision(4)+" msec"},p_pha_ramp:function(t){return t===0?"OFF":(1e3*t).toPrecision(4)+" msec/sec"},p_lpf_freq:function(t){return t===.1?"OFF":Math.round(8*44100*t/(1-t))+" Hz"},p_lpf_ramp:function(t){return t===1?"OFF":Math.pow(t,44100).toPrecision(4)+" ^sec"},p_lpf_resonance:function(t){return(100*(1-t*.11)).toPrecision(4)+"%"},p_hpf_freq:function(t){return t===0?"OFF":Math.round(8*44100*t/(1-t))+" Hz"},p_hpf_ramp:function(t){return t===1?"OFF":Math.pow(t,44100).toPrecision(4)+" ^sec"},sound_vol:function(t){return t=10*Math.log(t*t)/Math.log(10),(t>=0?"+":"")+t.toPrecision(4)+" dB"}},Ne={sfxr:A,convert:{sliders:Le,domain:He,sliders_inverse:We,domain_inverse:je,units:Ve},parameters:{order:tt,signed:Ye},Params:v,SoundEffect:W,waveforms:{SQUARE:J,SAWTOOTH:K,SINE:it,NOISE:$}},Ue=(...t)=>{const e=kt.createBufferSource(),i=kt.createBuffer(t.length,t[0].length,F);return t.map((n,r)=>i.getChannelData(r).set(n)),e.buffer=i,e.connect(kt.destination),e.start(),e},Ge=(t=1,e=.05,i=220,n=0,r=0,h=.1,a=0,p=1,c=0,w=0,d=0,m=0,f=0,x=0,S=0,P=0,q=0,E=1,D=0,O=0)=>{const M=2*Math.PI,z=c*=500*M/F**2,X=(S>0?1:-1)*M/4;let _=i*=(1+2*e*Math.random()-e)*M/F;const R=[];let g=0,T=0,b=0,H=1,ge=0,be=0,B=0,Z,j;for(n=99+F*n,D*=F,r*=F,h*=F,q*=F,w*=500*M/F**3,S*=M/F,d*=M/F,m*=F,f=F*f|0,j=n+D+r+h+q|0;b<j;R[b++]=B)++be%(100*P|0)||(B=a?a>1?a>2?a>3?Math.sin((g%M)**3):Math.max(Math.min(Math.tan(g),1),-1):1-(2*g/M%2+2)%2:1-4*Math.abs(Math.round(g/M)-g/M):Math.sin(g),B=(f?1-O+O*Math.sin(2*Math.PI*b/f):1)*(B>0?1:-1)*Math.abs(B)**p*t*Je*(b<n?b/n:b<n+D?1-(b-n)/D*(1-E):b<n+D+r?E:b<j-q?(j-b-q)/h*E:0),B=q?B/2+(q>b?0:(b<j-q?1:(j-b)/q)*R[b-q|0]/2):B),Z=(i+=c+=w)*Math.sin(T*S-X),g+=Z-Z*x*(1-1e9*(Math.sin(b)+1)%2),T+=Z-Z*x*(1-1e9*(Math.sin(b)**2+1)%2),H&&++H>m&&(i+=d,_+=d,H=0),!f||++ge%f||(i=_,c=z,H=H||1);return R},Je=.3,F=44100,kt=new(window.AudioContext||window.webkitAudioContext),Ke=(t,e,i,n=125)=>{let r,h,a,p,c,w,d,m,f,x,S,P,q,E,D=0,O=[],M=[],z=[],X=0,_=0,R=1,g={},T=F/n*60>>2;for(;R;X++)O=[R=m=P=0],i.map((b,H)=>{for(d=e[b][X]||[0,0,0],R|=!!e[b][X],E=P+(e[b][0].length-2-!m)*T,q=H==i.length-1,h=2,p=P;h<d.length+q;m=++h){for(c=d[h],f=h==d.length+q-1&&q||x!=(d[0]||0)|c|0,a=0;a<T&&m;a++>T-99&&f?S+=(S<1)/99:0)w=(1-S)*O[D++]/2||0,M[p]=(M[p]||0)-w*_+w,z[p]=(z[p++]||0)+w*_+w;c&&(S=c%1,_=d[1]||0,(c|=0)&&(O=g[[x=d[D=0]||0,c]]=g[[x,c]]||(r=[...t[x]],r[2]*=2**((c-12)/12),c>0?Ge(...r):[])))}P=E});return[M,z]},U={buffer:null,current:null},he={};function Ze(t){return new Promise(e=>{setTimeout(()=>e(Ke(...t)),20)})}async function Qe(){const t=["death","7BMHBGJp1pLzcwfGX3oUr5AAx4BaegfyaxSbpHMiF9ccaB41RnGD94gGi2ZGMe7XnMPXNVnd8t5MMJNeSfBVUfyZbqzLtQUyoDUx1cEJKni316fXo1wWw1LUw","hit","11111JWCBmwPrHgUYTY22NTVVr8ELS4dgMRCWNP4ns8uo45dKynKrqe7XiR39QS5DwF1ZSCPsFYYHsbLxajA7FBbsV5jBCaoUFRpTiHyCRTDSiKu5riJiJrj","laser","11111391dYeYMXRc68xUWiTmo4EknU8mxy28cRaz1XUJJN9LuCb38Z2VWXsiz2M2thZ84fV6jSV6rFeyffQ5cBNvDZUg74Ts4Lhz4Pd4aMLyzLehW7AugyUB","powerup","11111Ho5khiTQRjKTZGV85Lnkbu4eiX47XdQgTHxoBFpKR9maAsSaxoU3ecGMpQhzastitBEGd7KgWxpRjCWMDD2vW6Pk7QnK5abzbvCT8e9ZvtEVrZVyHuy"];for(let e=0;e<t.length;e+=2)setTimeout(()=>{he[t[e]]=Ne.sfxr.toAudio(t[e+1])});U.buffer=await Ze([[[1.8,0,72,,,.2,,4,-2,6,50,.15,,6],[,0,655,,,.09,3,1.65,,,,,.02,3.8,-.1,,.2],[1.2,0,23,,,.2,3,4,,,3,.9,.05],[1.5,0,740,,,.15,2,.2,-.1,-.15,9,.02,,.1,.12,,.06]],[[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,,,,,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,25,,,25,,25,25,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,]],[[3,-1,13,13,13,8,13,,,,,,,,,,,,11,11,11,6,11,,,,,,,,,,,,10,10,10,6,10,,,,,,,,,6,8,10,8,8,8,5,13,,8,8,8,5,13,8,8,8,5,13],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,25,,,,,,,,,,,,,25,25,,25,,,,,,,,,,,,,,25,,25,,,,,,,,,,,25,25,25,25,,25,,,,,,,,,,,,,,],[1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,13,13,13,13,13,13,13,13]],[[3,-1,13,13,13,8,13,,13,15,17,17,15,13,20,20,18,17,18,,,,17,,15,,,,17,,18,,22,22,22,,18,,,,25,25,25,,22,,,18,20,22,20,,,,,,,,,,,,,,,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,27,11,,23,,11,11,23,11,,11,23,11,11,11,23,22,18,,30,,18,18,30,18,,18,30,18,18,18,30,22,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,11,,23,,11,11,23,11,,11,23,11,11,11,23,,10,,22,,10,10,22,10,,10,22,10,10,6,8,10,20,25,20,20,25,20,,20,25,20,20,20,25,,20,,],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,13,,25,,13,13,25,13,,13,25,13,13,13,25,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,15,13,,17,15,13,,15,,,,10,13,15,10,13,15,10,13,15,10,13,15,12,,,,,,8,15,,,,,17,15,13,8,13,,,,,,10,8,,20,20,20,20,20,20,20],[2,-1,13,,25,,13,13,25,13,,13,25,13,13,13,25,,15,,27,,15,15,27,15,,15,27,15,15,15,27,32,20,,32,,20,20,32,20,,20,32,20,20,20,32,,13,,25,,13,13,25,20,,20,32,20,20,20,32,,],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[2,-1,13,,25,25,13,,25,25,13,,25,25,13,,25,25,15,,27,27,15,,27,27,15,,27,27,15,,27,27,20,,32,32,20,,32,32,20,,32,32,20,,32,32,13,,25,25,13,,25,25,20,,32,32,20,,32,34],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[3,-1,13,,,,,,8,,17,,,,18,17,15,,18,,,,13,,,,10,,,,6,,,,8,12,15,12,20,,8,12,15,12,20,,22,20,15,,13,,,,,,10,,8,,,,,8,20,8],[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13]],[[,1,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,,,25,25,,25,25,,,,,,25,,,,25,,,25,,,,25,25,25,25,25],[1,1,,,,,13,,,,,,,,13,,,,,,,,13,,,,,,,,13,,13,,,,,,13,,,,,,,,13,,,,,,,,13,13,,13,,13,13,13,13,13,13,13]]],[0,1,2,2,3,3,2,2,4,4,5,6,6,7,2,2,3]])}function Pt(t){$t(he[t]).play()}function $e(){U.current!=null?(U.current.stop(),U.current=null):U.current=Ue(...U.buffer)}class wt extends I{constructor(e){super(),this.entity=e}enter(e){const i=this.entity;i.dx=0,i.dy=0,i.isCollidable=!1,i.isSolid=!1,i.changeAnimation(i.direction),this.timer=0,Pt("death")}update(e){this.timer+=e,this.timer>De&&(this.entity.isDestroyed=!0)}}class Tt extends I{constructor(e){super(),this.entity=e}enter(e){const i=this.entity;i.dx=0,i.dy=0,i.changeAnimation(i.direction+4)}}class It extends I{constructor(e){super(),this.entity=e}enter(e){const i=this.entity;i.changeAnimation(i.direction+8)}}const C=[],gt=[];function St(t,e){e.forEach(i=>t.push(i))}class oe{constructor(e){this.x=e.x??0,this.y=e.y??0,this.width=e.width??y,this.height=e.height??y,this.dx=0,this.dy=0,this.isCollidable=!!e.isCollidable,this.isDestroyed=!1,this.isSolid=!!e.isSolid,this.tileOX=e.tileOX??0,this.tileOY=e.tileOY??0,this.tileID=e.tileID}render(){this.tileID!=null&&te(gt[this.tileID],this.x+this.tileOX,this.y+this.tileOY)}update(e){this.x+=this.dx*e,this.y+=this.dy*e}centerX(){return this.x+.5*this.width}centerY(){return this.y+.5*this.height}collided(e){}retreate(e){this.x-=this.dx*e,this.y-=this.dy*e}}class At extends oe{}function pe(t,e,i,n){return t=t/n,i*t*t*t+e}function ce(t,e,i,n){return t=t/n-1,i*(t*t*t+1)+e}function ti(t,e,i,n){return-i/2*(Math.cos(Math.PI*t/n)-1)+e}const ei=["#fff","#d72744","#79c834"];class fe extends At{constructor(e){super({x:e.x,y:e.y}),this.color=e.color??0,this.damage=e.damage,this.timer=0}render(){const e=pe(this.timer,this.y,-.5*y,Lt);k(ei[this.color]),L(8),Y(String(this.damage),this.x,e)}update(e){this.timer+=e,this.timer>=Lt&&(this.isDestroyed=!0)}}class bt extends I{constructor(e){super(),this.current=new I,this.states=e}change(e,i){this.current.exit(),this.current=this.states[e](),this.current.enter(i)}render(){this.current.render()}update(e){this.current.update(e)}}class Et extends oe{constructor(e){super({height:14,width:10,tileOX:-3,tileOY:-2,...e});const i=Te[e.character];this.animations=this.genAnimations(i),this.currentAnimation=this.animations[6],this.direction=2,this.state=new bt({death:()=>new wt(this),idle:()=>new Ct(this),stunned:()=>new Tt(this),walk:()=>new It(this)}),this.state.change("idle"),this.exp=0,this.level=1,this.stats=i.stats.slice()}render(){this.state.current instanceof wt?(k("#fff",.5),super.render(),k("#fff")):super.render()}update(e){this.currentAnimation?.update(e),this.tileID=this.currentAnimation?.getCurrentFrame(),this.state.update(e),super.update(e)}changeAnimation(e){this.currentAnimation=this.animations[e]}changeState(e,i){this.state.change(e,i)}genAnimations(e){return e.frames.map(i=>new Ie(i,e.frameInterval))}levelUp(){for(let e=0;e<this.stats.length;e+=2){const i=this.stats[e+1];for(let n=0;n<3;n++)lt(6)<i&&this.stats[e]++}}takeDamage(e,i,n,r){this.stats[Q.Hp]-=e,this.stats[Q.Hp]<=0&&this.changeState("death"),this.entities.push(new fe({x:i,y:n,color:r,damage:e}))}}class ue{constructor(e){const i=Math.min(200,.6*u.width),n=Math.min(100,.6*u.height);this.x=e.x??.5*(u.width-i),this.y=e.y??.5*(u.height-n),this.width=e.width??i,this.height=e.height??n}}class _e extends ue{render(){k("#fff",.75),Mt("fill",this.x,this.y,this.width,this.height,5)}}class ii{constructor(){this.metrics=[],this.panel=new _e({x:10,y:30,width:60,height:10})}render(){const e=.5*this.metrics.length;this.panel.height=10*e+10,this.panel.render(),k("#131313"),L(8);for(let i=0;i<this.metrics.length;i+=2)Y(`${this.metrics[i]}: ${this.metrics[i+1]}`,15,this.panel.y+5*(i+1))}update(e){this.metrics=["vw",u.width,"vh",u.height]}}class le extends ue{constructor(e){super(e),this.title=e.title,this.body=Array.isArray(e.body)?e.body:[e.body],this.bodyColor=e.bodyColor??"#000"}render(){const e=.5*(this.height-10*(this.body.length+3));k("#9f1d33"),L(12),Y(this.title,this.x,this.y+e,this.width,"center"),L(8),k(this.bodyColor),this.body.forEach((i,n)=>Y(i,this.x+4,this.y+e+10*n+30,this.width-8,this.body.length>1?"left":"center"))}}class ni extends I{constructor(e){super(),this.panel=new _e(e),this.textbox=new le(e),this.fn=e.handler??_t}render(){this.panel.render(),this.textbox.render()}update(e){ne.wasPressed()&&(C[0].pop(),this.fn())}}class si extends Ct{enter(e){super.enter(e)}update(e){const i=this.entity,n=i.entities[0],r=Ae*y;Math.abs(i.x-n.x)<r&&Math.abs(i.y-n.y)<r&&this.entity.changeState("walk")}}class ri extends It{enter(e){if(this.timer=0,e!=="flee"){const i=this.entity,n=i.entities[0],r=i.x-n.x,h=i.y-n.y;Math.abs(r)>Math.abs(h)?i.direction=r>0?rt.Left:rt.Right:i.direction=h>0?rt.Top:rt.Bottom;const a=mt[i.direction];i.dx=a[0]*Yt,i.dy=a[1]*Yt}super.enter(e)}update(e){this.timer+=e,this.timer>=Ee&&this.entity.changeState("idle")}}const Ht=["spirit1","spirit2"];class nt extends Et{constructor(e,i){super({x:e,y:i,isCollidable:!0,character:Ht[lt(Ht.length)]}),this.state=new bt({death:()=>new wt(this),idle:()=>new si(this),stunned:()=>new Tt(this),walk:()=>new ri(this)}),this.state.change("idle")}}const de=7,G=20,Ft=1.3*(G-de),jt=1,Vt=3;class ai{constructor(){this.isVisible=u.isMobile,this.reset()}render(){this.isVisible&&(k("rgba(255, 255, 255, 0.4)"),Rt("line",this.x,this.y,G),Rt("fill",this.x+this.offsetX,this.y+this.offsetY,de))}update(e){if(this.x=u.width-1.5*G,this.y=u.height-1.5*G,this.touchID){const n=ut.getPosition(this.touchID);if(n==null){this.reset();return}this.offsetX=Nt(n[0],this.x),this.offsetY=Nt(n[1],this.y),this.direction=hi(this.offsetX,this.offsetY);return}const i=ut.getTouches();i.length>0&&(this.isVisible=!0),i.some(n=>{const r=ut.getPosition(n);return r!=null&&Math.abs(r[0]-this.x)<G&&Math.abs(r[1]-this.y)<G?(this.touchID=n,!0):!1})}reset(){this.offsetX=0,this.offsetY=0,this.direction=-1,this.touchID=null}}function hi(t,e){return Math.abs(t)<jt&&(t=0),Math.abs(e)<jt&&(e=0),t===0&&e===0?-1:Math.abs(t)>=Math.abs(e)?t>0?1:3:e>0?2:0}function Nt(t,e){const i=xe(t-e,-Ft,Ft),n=Math.min(Vt,Math.abs(i/Ft));return ce(n,0,i,Vt)}class me extends At{constructor(e){const i=e.tileID;super({x:e.x,y:e.y,tileID:i,isSolid:oi(i)}),this.originalX=e.x,this.originalY=e.y}render(){super.render();const e=$t(this.tileID);e>=51&&e<=53&&te(gt[e-12],this.x,this.y-this.height)}}function oi(t){return t%12<7}class Dt extends I{constructor(e){super(),this.entity=e}}class pi extends Dt{update(e){const i=this.entity,n=mt[i.direction],r=1.5*y,h=i.centerX()+n[0]*(.5*i.width+r),a=i.centerY()+n[1]*(.5*i.height+r),p=i.entities.filter(c=>!(!(c instanceof nt)||Math.abs(c.centerX()-h)>r||Math.abs(c.centerY()-a)>r));p.length>0&&i.blasterWeapon.change("fire",p[0])}}class ci extends Dt{enter(){this.timer=0,this.timerDuration=.5}update(e){this.timer+=e,this.timer>=this.timerDuration&&this.entity.blasterWeapon.change("aim")}}class ye extends At{constructor(e){super({x:e.x,y:e.y,width:e.size??1,height:e.size??1,isCollidable:!0,isSolid:!1}),this.dx=e.dx,this.dy=e.dy,this.startX=e.x,this.startY=e.y,this.damage=e.damage}render(){k("red"),Ce(this.startX,this.startY,this.x,this.y)}update(e){super.update(e),Math.max(Math.abs(this.startX-this.x),Math.abs(this.startY-this.y))>=3*y&&(this.isDestroyed=!0)}collided(e){e instanceof nt&&e.takeDamage(this.damage,this.x,this.y,2)}}class fi extends Dt{enter(e){const i=this.entity;if(!(e instanceof nt))throw new Error("expected enemy");const n=e.centerX()-i.centerX(),r=e.centerY()-i.centerY(),h=Math.max(Math.abs(n),Math.abs(r));i.entities.push(new ye({x:i.centerX(),y:i.centerY(),dx:n/h*240,dy:r/h*240,damage:i.stats[Q.Attack]})),i.blasterWeapon.change("cooldown"),Pt("laser")}}class ui extends Ct{update(e){const i=this.entity.joystick,n=i.direction>-1?i.direction:se.findIndex(r=>dt.wasPressed(r));n>-1&&(this.entity.direction=n,this.entity.changeState("walk")),super.update(e)}}class _i extends It{update(e){const i=this.entity.joystick,n=i.direction>-1?i.direction:se.findIndex(h=>dt.wasHolding(h)),r=this.entity;n>-1?(r.direction=n,r.dx=mt[n][0]*Bt,r.dy=mt[n][1]*Bt,r.changeAnimation(r.direction+8)):r.changeState("idle")}}class li extends Et{constructor(e,i){super({x:e,y:i,isCollidable:!0,isSolid:!0,character:"player"}),this.state=new bt({death:()=>new wt(this),idle:()=>new ui(this),stunned:()=>new Tt(this),walk:()=>new _i(this)}),this.state.change("idle"),this.blasterWeapon=new bt({aim:()=>new pi(this),cooldown:()=>new ci(this),fire:()=>new fi(this)}),this.blasterWeapon.change("aim"),this.invulnerableTimer=0}render(){const e=ti(qt-this.invulnerableTimer,0,1,qt);k("#fff",e),super.render(),k("#fff")}update(e){this.invulnerableTimer=Math.max(0,this.invulnerableTimer-e),this.blasterWeapon.update(e),super.update(e)}collided(e){e instanceof nt&&this.invulnerableTimer===0&&(this.invulnerableTimer=qt,this.takeDamage(e.stats[Q.Attack],this.centerX(),this.centerY(),1),Pt("hit"))}}class xt extends I{static check(){Ut()&&C[0].push(new xt)}render(){k("#322c7d"),Mt("fill",0,0,u.width,u.height),k("#fff"),L(16);let e=.5*u.height-60;"Please use landscape mode".split(" ").forEach(i=>Y(i,8,e=e+20))}update(e){Ut()||C[0].pop()}}function Ut(){return .64*u.height>u.width}const pt=[800,21,1700,0,201,27,401,29,601,30,801,21,1001,27,1101,46,1201,29,1401,26,1601,11,202,58,502,46,802,21,902,47,1202,58,203,30,303,45,403,26,803,19,1203,25,1303,47,1403,27,1503,58,704,8,804,9,904,10,1304,7,1404,21,1504,21,1604,21,105,21,205,21,305,7,405,21,505,21,705,20,805,21,905,22,1105,21,1205,21,106,58,706,32,806,33,906,34,1506,11,207,28,407,26,1007,26,1207,28,1407,30,1607,45,8,49,508,58,808,21,1508,53,9,0,109,25,209,27,309,51,409,30,609,28,809,21,909,44,1009,25,1109,27,1209,30,1309,37,1409,26,1609,50,1709,51],ct=18,ft=10;class di{constructor(){this.setViewport(),this.offsetX=this.startX(),this.offsetY=this.startY(),this.repeat=Math.ceil(Math.max(this.viewportWidth/ct,this.viewportHeight/ft)),this.obstacles=[],this.terrain=[];for(let e=0;e<this.repeat;e++)for(let i=0;i<this.repeat;i++)for(let n=0;n<pt.length;n+=2){const r=(Math.floor(pt[n]/100)+i*ct)*y,h=(pt[n]%100+e*ft)*y,a=pt[n+1],p=new me({x:r,y:h,tileID:a});(p.isSolid?this.obstacles:this.terrain).push(p)}this.updateMap()}render(){this.terrain.forEach(e=>e.render())}update(e){this.setViewport()}renderBg(){k("#000023"),Mt("fill",0,0,u.width,u.height)}setViewport(){this.viewportWidth=Math.ceil(u.width/y),this.viewportHeight=Math.ceil(u.height/y)}startX(){return .5*(ct-this.viewportWidth)*y}startY(){return .5*(ft-this.viewportHeight)*y+y}updateObstacles(e,i){const n=ct*this.repeat*y,r=ft*this.repeat*y;e.forEach(h=>{Qt(h,i,y)||(h.x=Gt(h.x,n,i.x,i.width),h.y=Gt(h.y,r,i.y,i.height))})}updateMap(){const e={x:this.offsetX,y:this.offsetY,width:this.viewportWidth*y,height:this.viewportHeight*y};this.updateObstacles(this.obstacles,e),this.updateObstacles(this.terrain,e)}updateViewpoint(e,i){(this.offsetX!==e||this.offsetY!==i)&&(this.offsetX=e,this.offsetY=i,this.updateMap())}}function Gt(t,e,i,n){return t<i-y?t+e:t>i+n?t-e:t}const mi="#28314A",Jt=.4;class et extends I{static transitionTo(e){C[0].push(new et({fadeIn:!0,handler:()=>{C[0].pop(),C[0].push(e),C[0].push(new et({fadeIn:!1}))}}))}constructor(e){super(),this.fadeIn=e.fadeIn,this.easing=e.fadeIn?pe:ce,this.opacity=e.fadeIn?0:1,this.timer=0,this.fn=e.handler??_t}render(){k(mi,this.opacity),Mt("fill",0,0,u.width,u.height)}update(e){this.timer+=e,this.opacity=this.easing(this.timer,this.fadeIn?0:1,this.fadeIn?1:-1,Jt),this.timer>=Jt&&(C[0].pop(),this.fn())}}class yi extends I{enter(){this.tileMap=new di,this.cameraX=this.tileMap.startX(),this.cameraY=this.tileMap.startY();const e=this.player=new li(8*y+3,5*y);this.entities=[e].concat(this.tileMap.obstacles),this.genEnemies(),this.console=new ii,this.joystick=new ai,e.entities=this.entities,e.joystick=this.joystick}render(){this.tileMap.renderBg(),Ot(-this.cameraX,-this.cameraY),this.tileMap.render(),wi(this.entities).forEach(i=>i.render()),Ot(this.cameraX,this.cameraY),L(8);const e=.1*this.player.stats[Q.Hp];Y("❤️".repeat(Math.min(10,e)),5,5),e>10&&Y("❤️".repeat(e-10),5,15),this.console.render(),this.joystick.render()}update(e){xt.check(),this.console.update(e),this.joystick.isVisible&&this.console.metrics.push("ox",this.joystick.offsetX.toFixed(2),"oy",this.joystick.offsetY.toFixed(2),"jd",this.joystick.direction),this.joystick.update(e),this.tileMap.update(e),Me(this.entities,(r,h)=>{r.update(e),r.isDestroyed&&this.entities.splice(h,1)});const i=this.entities.filter(r=>r.isCollidable||r.isSolid);i.forEach((r,h)=>{for(let a=h+1;a<i.length;++a){const p=i[a];Qt(r,p,1)&&(r.isSolid&&p.isSolid&&(r.retreate(e),p.retreate(e)),r.isCollidable&&p.isCollidable&&(r.collided(p),p.collided(r)))}});const n=this.entities[0];this.cameraX=this.updateCamera(this.cameraX,n.x,.3*u.width,.7*u.width),this.cameraY=this.updateCamera(this.cameraY,n.y,.3*u.height,.7*u.height),this.tileMap.updateViewpoint(this.cameraX,this.cameraY),this.player.isDestroyed&&C[0].push(new ni({title:"Game Over",body:"Do better next time!",handler:()=>et.transitionTo(new we(1))}))}genEnemies(){for(let e=0;e<10;++e){const i=new nt(lt(y,18*y),lt(y,9*y));i.entities=this.entities,this.entities.push(i)}}updateCamera(e,i,n,r){return i<e+n?i-n:i>e+r?i-r:e}}function Kt(t){return t instanceof Et||t instanceof me?1:t instanceof ye?2:t instanceof fe?3:0}function wi(t){return t.slice().sort((e,i)=>{const n=Kt(e),r=Kt(i);return n!==r?n-r:e.y-i.y})}const Zt="Spirit Hunter";class we extends I{constructor(e){super(),this.page=e??0}render(){switch(this.page){case 0:{k("#9F1D33"),L(24),Y(Zt,0,.5*u.height-32,null,"center"),k("#fff"),L(12),Y("Press to ENTER start",0,.5*u.height+16,null,"center");break}case 1:{new le({title:Zt,body:["Controls:","",u.isMobile?"Use joystick to":"Use W,A,S,D keys to","move the character"],bodyColor:"#fff"}).render();break}}}update(e){xt.check(),ne.wasPressed()&&(this.page<1?this.page++:(et.transitionTo(new yi),$e()))}}class gi{constructor(){this.stack=[]}pop(){this.stack[this.stack.length-1].exit(),this.stack.pop()}push(e){e.enter(),this.stack.push(e)}render(){this.stack.forEach(e=>e.render())}update(e){this.stack[this.stack.length-1].update(e)}}async function bi(){St(gt,zt(await Xt("./tilemap2.png"),16,16)),St(gt,zt(await Xt("./characters2.png"),16,16)),await Qe(),St(C,[new gi]),C[0].push(new we)}function Mi(t){C[0].update(t)}function xi(){C[0].render()}Pe(bi,Mi,xi);